<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <title>Zombie Survival - Advanced Base</title>
    <style>
        body { margin: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        canvas { display: block; }
        #ui {
            position: absolute; top: 10px; left: 10px; padding: 15px;
            background: rgba(0,0,0,0.8); border-radius: 8px; pointer-events: none; border: 1px solid #444;
        }
        #build-menu {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; background: rgba(0,0,0,0.9); padding: 10px; border-radius: 10px;
        }
        .slot { padding: 5px 12px; border: 2px solid #444; border-radius: 5px; font-size: 12px; }
        .active { border-color: #00f0ff; background: rgba(0, 240, 255, 0.2); }
        
        #crafting-ui {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(20, 20, 40, 0.95); padding: 20px; border: 3px solid #00f0ff;
            border-radius: 15px; display: none; text-align: center;
        }
        #game-over {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(139, 0, 0, 0.8); display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        button { 
            padding: 10px 20px; font-size: 18px; cursor: pointer; background: #00f0ff; 
            border: none; border-radius: 5px; margin-top: 10px; font-weight: bold;
        }
        button:hover { background: #fff; }
    </style>
</head>
<body>

<div id="ui">
    <div id="time-display" style="font-weight: bold;">Dag 1</div>
    <div style="color: #ffeb3b;">Materialer: <span id="mat-count">50</span> | Coins: <span id="coin-count">0</span></div>
    <div style="color: #ff4444;">Base HP: <span id="base-hp">500</span> | Din HP: <span id="player-hp">50</span></div>
    <div id="phase-msg" style="color: #4ade80;">SAMLE MATERIALER</div>
</div>

<div id="crafting-ui">
    <h2>CRAFTING BENCH</h2>
    <p>Bruk coins for å oppgradere utstyret ditt</p>
    <div style="display: flex; gap: 10px; justify-content: center;">
        <button onclick="upgradePistol()">Oppgrader Pistol (20 Coins)</button>
        <button onclick="upgradeTurrets()">Sterkere Turrets (40 Coins)</button>
    </div>
    <br>
    <button onclick="toggleCrafting(false)" style="background: #555;">Lukk (X)</button>
</div>

<div id="game-over">
    <h1 style="font-size: 60px;">DU DØDE!</h1>
    <button onclick="location.reload()">START PÅ NYTT</button>
</div>

<div id="build-menu">
    <div class="slot" id="slot1">1: Vegg (10)</div>
    <div class="slot" id="slot2">2: Forsterket Vegg (25)</div>
    <div class="slot" id="slot3">3: Gulv (5)</div>
    <div class="slot" id="slot4">4: Trapp (8)</div>
    <div class="slot" id="slot5">5: Dør (15)</div>
    <div class="slot" id="slot6">6: Turret (30)</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// --- STATE ---
const WORLD_WIDTH = 5000;
const GROUND_Y = canvas.height - 100;

let state = {
    day: 1, isDay: true, timeLeft: 180,
    materials: 100, coins: 0,
    buildMode: 1, isBuilding: false,
    ghostX: 0, ghostY: 0, cameraX: 0,
    pistolLevel: 0, turretLevel: 0,
    lastShot: 0
};

let player = { 
    x: WORLD_WIDTH / 2, y: GROUND_Y - 50, w: 30, h: 50, 
    vx: 0, vy: 0, speed: 5, jump: 12, hp: 50 
};

let base = { x: WORLD_WIDTH / 2 - 100, y: GROUND_Y - 120, w: 200, h: 120, hp: 500 };
let bench = { x: WORLD_WIDTH / 2 - 20, y: GROUND_Y - 40, w: 40, h: 40 };

let structures = [];
let zombies = [];
let projectiles = [];
let chests = [];
const keys = {};

// --- INITIALIZE ---
function init() {
    spawnDayChests();
    updateUI();
}

// --- INPUT ---
window.addEventListener('keydown', e => {
    keys[e.code] = true;
    if (e.code === 'KeyS') toggleBuildMode();
    if (e.code === 'KeyE') interact();
    if (e.key >= '1' && e.key <= '6') state.buildMode = parseInt(e.key);
});
window.addEventListener('keyup', e => keys[e.code] = false);

window.addEventListener('mousedown', e => {
    if (state.isBuilding) buildAtGhost();
    else shootPistol(e);
});

function toggleBuildMode() {
    state.isBuilding = !state.isBuilding;
    if(state.isBuilding) {
        state.ghostX = Math.floor(player.x / 40) * 40;
        state.ghostY = Math.floor(player.y / 40) * 40;
    }
}

function interact() {
    // Sjekk Crafting Bench
    if (Math.hypot(player.x - bench.x, player.y - bench.y) < 60) {
        toggleCrafting(true);
    }
    // Sjekk Dører
    structures.forEach(s => {
        if(s.type === 'door' && Math.hypot(player.x - s.x, player.y - s.y) < 60) {
            s.isOpen = !s.isOpen;
        }
    });
    // Sjekk Kister
    chests.forEach((c, i) => {
        if (Math.hypot(player.x - c.x, player.y - c.y) < 60) {
            state.materials += Math.floor(Math.random() * 16) + 10;
            chests.splice(i, 1);
        }
    });
}

function shootPistol(e) {
    let now = Date.now();
    let cooldown = 5000 - (state.pistolLevel * 1000); // Starter på 5 sek
    if (cooldown < 500) cooldown = 500;

    if (now - state.lastShot > cooldown) {
        let worldMouseX = e.clientX + state.cameraX;
        let worldMouseY = e.clientY;
        projectiles.push({
            x: player.x, y: player.y + 10, 
            tx: worldMouseX, ty: worldMouseY, 
            dmg: 2 + state.pistolLevel * 2, speed: 12, color: 'yellow'
        });
        state.lastShot = now;
    }
}

function upgradePistol() {
    if (state.coins >= 20) { state.coins -= 20; state.pistolLevel++; updateUI(); }
}

function upgradeTurrets() {
    if (state.coins >= 40) { state.coins -= 40; state.turretLevel++; updateUI(); }
}

function toggleCrafting(show) {
    document.getElementById('crafting-ui').style.display = show ? 'block' : 'none';
}

function buildAtGhost() {
    let costs = [0, 10, 25, 5, 8, 15, 30];
    let cost = costs[state.buildMode];
    if (state.materials < cost) return;

    let types = ["", "wall", "wall_strong", "floor", "stair", "door", "turret"];
    let type = types[state.buildMode];
    let hp = (type === 'wall_strong') ? 100 : (type === 'wall' ? 15 : 50);
    
    structures.push({ 
        x: state.ghostX, y: state.ghostY, w: 40, h: 40, 
        type: type, hp: hp, isOpen: false, lastShot: 0 
    });
    
    state.materials -= cost;
    updateUI();
}

// --- UPDATE LOOP ---
function update() {
    if (player.hp <= 0 || base.hp <= 0) {
        document.getElementById('game-over').style.display = 'flex';
        return;
    }

    // Tid
    state.timeLeft -= 1/60;
    if (state.timeLeft <= 0) {
        state.isDay = !state.isDay;
        state.timeLeft = state.isDay ? 180 : 90;
        if (state.isDay) { state.day++; spawnDayChests(); }
    }

    // Bevegelse og Kollisjon
    if (state.isBuilding) {
        if (keys['KeyA']) state.ghostX -= 40;
        if (keys['KeyD']) state.ghostX += 40;
        if (keys['KeyW']) state.ghostY -= 40;
        if (keys['KeyS']) state.ghostY += 40;
        keys['KeyA'] = keys['KeyD'] = keys['KeyW'] = keys['KeyS'] = false;
    } else {
        player.vx = (keys['KeyA'] ? -player.speed : (keys['KeyD'] ? player.speed : player.vx * 0.8));
        player.vy += 0.6;
        
        let oldY = player.y;
        player.x += player.vx;
        player.y += player.vy;

        // Solid Kollisjon (Vegger og lukkede dører)
        structures.forEach(s => {
            if ((s.type.includes('wall') || (s.type === 'door' && !s.isOpen))) {
                if (player.x < s.x + s.w && player.x + player.w > s.x && player.y < s.y + s.h && player.y + player.h > s.y) {
                    player.x -= player.vx;
                }
            }
            // Enveis-plattform (Gulv og Trapper)
            if (s.type === 'floor' || s.type === 'stair') {
                if (player.vx >= 0 && player.x + player.w > s.x && player.x < s.x + s.w) {
                    if (oldY + player.h <= s.y && player.y + player.h >= s.y) {
                        player.y = s.y - player.h;
                        player.vy = 0;
                    }
                }
            }
        });

        if (player.y + player.h > GROUND_Y) { player.y = GROUND_Y - player.h; player.vy = 0; }
        if (keys['KeyW'] && player.vy === 0) player.vy = -player.jump;
    }

    // Kamera
    state.cameraX = player.x - canvas.width / 2;
    state.cameraX = Math.max(0, Math.min(state.cameraX, WORLD_WIDTH - canvas.width));

    // Zombier
    let targetZombies = state.isDay ? 3 : (3 + state.day * 2);
    if (zombies.length < targetZombies && Math.random() < 0.01) spawnZombie();

    zombies.forEach((z, zi) => {
        let isBlocked = false;
        let targetX = (!state.isDay) ? base.x + 100 : player.x;
        
        // Sjekk kollisjon med vegger for zombier
        structures.forEach(s => {
            if ((s.type.includes('wall') || (s.type === 'door' && !s.isOpen)) && Math.abs(z.x - s.x) < 30 && Math.abs(z.y - s.y) < 40) {
                isBlocked = true;
                if (Date.now() - (z.lastAtk || 0) > 2000) {
                    s.hp -= 10;
                    z.lastAtk = Date.now();
                }
            }
        });

        if (!isBlocked) {
            z.x += (z.x < targetX ? 1 : -1);
        }

        // Angrip spiller eller base
        if (Math.hypot(z.x - player.x, z.y - player.y) < 30) {
            if (Date.now() - (z.lastAtk || 0) > 2000) { player.hp -= 10; z.lastAtk = Date.now(); updateUI(); }
        }
        if (z.x > base.x && z.x < base.x + base.w) {
            if (Date.now() - (z.lastAtk || 0) > 2000) { base.hp -= 10; z.lastAtk = Date.now(); updateUI(); }
        }
    });

    // Turrets logikk
    structures.forEach(s => {
        if(s.type === 'turret') {
            let now = Date.now();
            let rate = state.turretLevel > 0 ? 800 : 3000;
            let dmg = state.turretLevel > 0 ? 1 : 3;
            if (now - s.lastShot > rate) {
                let target = zombies.find(z => Math.hypot(z.x - s.x, z.y - s.y) < 500);
                if (target) {
                    projectiles.push({ x: s.x + 20, y: s.y + 10, tx: target.x, ty: target.y, dmg: dmg, speed: 10, color: '#f0f' });
                    s.lastShot = now;
                }
            }
        }
    });

    // Prosjektiler
    projectiles.forEach((p, pi) => {
        let angle = Math.atan2(p.ty - p.y, p.tx - p.x);
        p.x += Math.cos(angle) * p.speed;
        p.y += Math.sin(angle) * p.speed;
        zombies.forEach((z, zi) => {
            if (Math.hypot(p.x - z.x, p.y - z.y) < 20) {
                z.hp -= p.dmg;
                projectiles.splice(pi, 1);
                if (z.hp <= 0) { zombies.splice(zi, 1); state.coins += 5; updateUI(); }
            }
        });
    });

    // Rydding
    structures = structures.filter(s => s.hp > 0);
}

function spawnZombie() {
    let side = Math.random() > 0.5 ? 0 : WORLD_WIDTH;
    zombies.push({ x: side, y: GROUND_Y - 40, hp: 15 });
}

function spawnDayChests() {
    chests = [];
    for(let i=0; i<6; i++) chests.push({ x: Math.random()*WORLD_WIDTH, y: GROUND_Y - 30 });
}

function draw() {
    ctx.fillStyle = state.isDay ? '#87CEEB' : '#050520';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.save();
    ctx.translate(-state.cameraX, 0);

    // Bakke & Base
    ctx.fillStyle = '#222'; ctx.fillRect(0, GROUND_Y, WORLD_WIDTH, 100);
    ctx.fillStyle = '#444'; ctx.fillRect(base.x, base.y, base.w, base.h);
    
    // Crafting Bench
    ctx.fillStyle = '#00f0ff'; ctx.fillRect(bench.x, bench.y, bench.w, bench.h);
    ctx.fillStyle = '#fff'; ctx.fillText("BENCH (E)", bench.x, bench.y - 10);

    // Kister
    ctx.fillStyle = '#8b4513'; chests.forEach(c => ctx.fillRect(c.x, c.y, 40, 30));

    // Strukturer
    structures.forEach(s => {
        if(s.type === 'wall') ctx.fillStyle = '#666';
        else if(s.type === 'wall_strong') ctx.fillStyle = '#222';
        else if(s.type === 'door') ctx.fillStyle = s.isOpen ? 'rgba(100,50,0,0.3)' : '#630';
        else if(s.type === 'turret') ctx.fillStyle = '#f0f';
        else ctx.fillStyle = '#444';

        if(s.type === 'stair') {
            ctx.beginPath(); ctx.moveTo(s.x, s.y+40); ctx.lineTo(s.x+40, s.y); ctx.lineTo(s.x+40, s.y+40); ctx.fill();
        } else {
            ctx.fillRect(s.x, s.y, s.w, s.h);
        }
    });

    // Zombier
    ctx.fillStyle = '#4ade80'; zombies.forEach(z => ctx.fillRect(z.x, z.y, 30, 40));

    // Prosjektiler
    projectiles.forEach(p => {
        ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, 4, 0, Math.PI*2); ctx.fill();
    });

    // Spiller
    ctx.fillStyle = state.isBuilding ? '#0ff' : '#fff';
    ctx.fillRect(player.x, player.y, player.w, player.h);

    if (state.isBuilding) {
        ctx.strokeStyle = '#0ff'; ctx.strokeRect(state.ghostX, state.ghostY, 40, 40);
    }

    ctx.restore();

    update();
    requestAnimationFrame(draw);
}

function updateUI() {
    document.getElementById('mat-count').innerText = state.materials;
    document.getElementById('coin-count').innerText = state.coins;
    document.getElementById('player-hp').innerText = player.hp;
    document.getElementById('base-hp').innerText = base.hp;
    document.getElementById('time-display').innerText = `Dag ${state.day} - ${Math.floor(state.timeLeft/60)}:${Math.floor(state.timeLeft%60).toString().padStart(2,'0')}`;
    for(let i=1; i<=6; i++) document.getElementById('slot'+i).className = (state.buildMode === i ? 'slot active' : 'slot');
}

init();
draw();
</script>
</body>
</html>
